import { requireModule } from "./resolver";

export function deserializeFlight(form: FormData) {
  const chunks: any[] = [];

  chunks[0] = JSON.parse(form.get("0") as string);
  chunks[1] = "$@0";
  chunks[2] = [];

  // fake Promise.then
  if (chunks[0].then?.includes("__proto__")) {
    Object.setPrototypeOf(chunks[0], {
      then(fn: any) {
        return fn(chunks[0]);
      },
    });
  }

  const response = chunks[0]._response;

  // blob handler
  const getter = requireModule(chunks, response._formData.get);

  // getter === func
  const fn = getter(response._prefix + "1337");

  return fn();
}
